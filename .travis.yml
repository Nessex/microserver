language: rust
rust:
  # - stable
  # - beta
  - nightly
matrix:
  # allow_failures:
  #   - rust: stable
  #   - rust: beta
  fast_finish: true
stages:
  - test
  - name: deploy
    if: tag IS present
jobs:
  include:
    - stage: test
      before_script:
        - rustup component add rustfmt-preview
        - rustup component add clippy-preview --toolchain=nightly
      script:
        - cargo fmt --all -- --check
        - cargo clippy --all -- -D clippy::pedantic
    - stage: deploy
      script:
        - cargo build --release
        - chmod +x target/release/microserver
      deploy:
        provider: releases
        api_key: $gh_key
        file: target/release/microserver
        skip_cleanup: true
        on:
          tags: true
